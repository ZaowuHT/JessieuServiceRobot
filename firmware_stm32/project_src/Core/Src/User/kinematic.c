#include "kinematic.h"

uint8_t Kinematic_ChassisConfigBinary[KINEMATIC_CHASSIS_CONFIG_SIZE] = {
0x50,0x05,0x00,0x50,0x0c,0x43,0x30,0x0c,0x64,0x69,0x66,0x66,0x65,0x72,0x65,0x6e,
0x74,0x69,0x61,0x6c,0x05,0x1a,0x00,0x00,0x00,0x00,0x01,0x1a,0xff,0x00,0x00,0x00,
0x02,0x30,0x12,0x43,0x6f,0x64,0x65,0x73,0x20,0x26,0x20,0x54,0x68,0x69,0x6e,0x67,
0x73,0x20,0x4c,0x61,0x62,0x03,0x1a,0x11,0xdd,0x00,0x00,0x04,0x30,0x17,0x53,0x65,
0x72,0x76,0x69,0x63,0x65,0x20,0x52,0x6f,0x62,0x6f,0x74,0x20,0x50,0x72,0x6f,0x74,
0x6f,0x74,0x79,0x70,0x65,0x3f,0x20,0xec,0x51,0x38,0x3e,0x3e,0x20,0xcd,0xcc,0x4c,
0x3e,0x06,0x20,0x08,0xc9,0xc2,0x3e,0x0a,0x40,0x02,0x50,0x05,0x19,0x1a,0x00,0x00,
0x00,0x00,0x0d,0x50,0x02,0x0e,0x20,0x7f,0x6a,0x3c,0x3e,0x10,0x20,0xd0,0xb3,0x99,
0x3d,0x3c,0x20,0x00,0x00,0x90,0x40,0x3d,0x20,0x8f,0xc2,0xf5,0x3c,0x0b,0x31,0x15,
0x50,0x04,0x19,0x1a,0x01,0x00,0x00,0x00,0x0d,0x50,0x03,0x0e,0x20,0xe3,0xa5,0x1b,
0xbd,0x11,0x20,0xdb,0x0f,0x49,0x40,0x10,0x20,0xd0,0xb3,0x99,0x3d,0x3d,0x20,0x8f,
0xc2,0xf5,0x3c,0x0b,0x31,0x15,0x27,0x50,0x02,0x26,0x60,0x11,0x20,0xe4,0xcb,0x96,
0xc0,0x28,0x20,0x6a,0xbc,0x74,0x3e,0x1f,0x50,0x01,0x21,0x61,0x16,0x50,0x01,0x17,
0x61,0x18,0x50,0x04,0x2a,0x40,0x04,0x50,0x02,0x2c,0x20,0x0b,0xbc,0xac,0x3f,0x2b,
0x20,0xab,0x63,0x65,0x3f,0x50,0x02,0x2c,0x20,0x0b,0xbc,0xac,0x3f,0x2b,0x20,0xd8,
0xe0,0x1d,0x40,0x50,0x02,0x2c,0x20,0x0b,0xbc,0xac,0x3f,0x2b,0x20,0x63,0x34,0x81,
0x40,0x50,0x02,0x2c,0x20,0x0b,0xbc,0xac,0x3f,0x2b,0x20,0x5a,0x78,0xb3,0x40,0x37,
0x20,0x08,0xc9,0x42,0x3e,0x2f,0x1a,0x3c,0x00,0x00,0x00,0x0d,0x50,0x02,0x0e,0x20,
0x6f,0x12,0x83,0x3d,0x11,0x20,0xdb,0x0f,0x49,0x40,0x1a,0x50,0x05,0x39,0x20,0x00,
0x00,0x80,0x3f,0x42,0x20,0x00,0x00,0x00,0x40,0x40,0x20,0x00,0x00,0x80,0x3f,0x41,
0x20,0x00,0x00,0x80,0x3f,0x1e,0x20,0x00,0x00,0x00,0x00
};
struct RobotDisplacement robotDisplacement;

void Kinematic_SetSpeed(float speedX, float speedYaw)
{
	float _lineSpeed = speedYaw * KINEMATIC_CHASSIS_RADIUS;
	float _leftSpeed = speedX - _lineSpeed;
	float _rightSpeed = speedX + _lineSpeed;
	int32_t _leftSpeedPPS = (int32_t) (_leftSpeed * MOTOR_PPR / (PI * 2 * KINEMATIC_WHEEL_RADIUS));
	int32_t _rightSpeedPPS = (int32_t) (_rightSpeed * MOTOR_PPR / (PI * 2 * KINEMATIC_WHEEL_RADIUS));
	Motor_SetSpeedPPS(MOTOR_LEFT, _leftSpeedPPS);
	Motor_SetSpeedPPS(MOTOR_RIGHT, _rightSpeedPPS);
}

void Kinematic_UpdateDisplacement(void)
{
	osMutexAcquire(motorDataMutexHandle, osWaitForever);
	float _leftDisplacement = 
		(robotMotorData[MOTOR_LEFT].encoderCountPeriod * PI * 2 * KINEMATIC_WHEEL_RADIUS) / MOTOR_PPR;
	float _rightDisplacement = 
		(robotMotorData[MOTOR_RIGHT].encoderCountPeriod * PI * 2 * KINEMATIC_WHEEL_RADIUS) / MOTOR_PPR;
	float _dyaw = (_rightDisplacement - _leftDisplacement) / (2 * KINEMATIC_CHASSIS_RADIUS);
	robotDisplacement.displacementX = ((_rightDisplacement + _leftDisplacement) / 2) * cos(_dyaw);
	robotDisplacement.displacementY = ((_rightDisplacement + _leftDisplacement) / 2) * sin(_dyaw);
	robotDisplacement.displacementYaw = _dyaw;
	osMutexRelease(motorDataMutexHandle);
}

void Kinematic_ClearDisplacement(void)
{
	osMutexAcquire(motorDataMutexHandle, osWaitForever);
	robotDisplacement.displacementX = 0;
	robotDisplacement.displacementY = 0;
	robotDisplacement.displacementYaw = 0;
	robotMotorData[MOTOR_LEFT].encoderCountPeriod =  0;
	robotMotorData[MOTOR_RIGHT].encoderCountPeriod =  0;
	osMutexRelease(motorDataMutexHandle);
}
